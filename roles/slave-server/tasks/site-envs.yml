---
# git checkout
- name: site env git checkout
  sudo: true
  git:
    dest={{tsadm_homedir}}/sites/{{tsadmdb_siteenv[item].site_name}}/{{tsadmdb_siteenv[item].name}}
    repo={{tsadmdb_siteenv[item].site_repo_uri}}
    key_file={{tsadm_homedir}}/.ssh/id_rsa
    accept_hostkey=yes
    force=no
  with_items:
    tsadm_slave_siteenvs
  tags:
    - tsadm-site
    - site-envs


# env files/dirs permissions
- name: site env perms
  sudo: true
  site_env_perms:
    env_basedir={{tsadm_homedir}}/sites/{{tsadmdb_siteenv[item].site_name}}/{{tsadmdb_siteenv[item].name}}
    owner={{tsadm_user}}
    group={{hostvars[inventory_hostname].tsadm_apache_runcfg.group.name}}
    public_owner={{tsadmdb_siteenv[item].site_slug}}
    public_group={{hostvars[inventory_hostname].tsadm_apache_runcfg.group.name}}
    public_dir_mode=2770
    public_file_mode=0660
    public_path_regex=r'.*/sites/.*/files($|/.*)'
  with_items:
    tsadm_slave_siteenvs
  tags:
    - tsadm-site
    - site-envs
    - site-env-perms


# siteenv drupal settings dir
- name: siteenv drupal settings dir
  sudo: true
  file: path={{tsadm_homedir}}/drupal-settings
    state=directory
    group={{hostvars[inventory_hostname].tsadm_apache_runcfg.group.name}}
    mode=0510
  with_items:
    tsadm_slave_siteenvs
  tags:
    - tsadm-site
    - site-envs


# siteenv drupal db settings
- name: siteenv drupal db settings
  sudo: true
  template: dest={{tsadm_homedir}}/drupal-settings/{{tsadmdb_siteenv[item].site_name}}.{{tsadmdb_siteenv[item].name}}-db.php
    src=siteenv-drupal-settings-db.php
    mode=0440
    owner={{tsadm_user}}
    group={{hostvars[inventory_hostname].tsadm_apache_runcfg.group.name}}
    validate='php -l %s'
  with_items:
    tsadm_slave_siteenvs
  tags:
    - tsadm-site
    - site-envs
